<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Kali Rush — Neon Lanes · CrackTheCode</title>
  <style>
    :root{
      --bg:#02000b;
      --panel:#050017;
      --accent:#5bffbf;
      --accent2:#2de4ff;
      --accent3:#ff5af2;
      --muted:#a0aec0;
      --danger:#ff4b81;
      --font-ui:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
      --font-mono:"Fira Code","JetBrains Mono",ui-monospace,monospace;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      background:
        radial-gradient(circle at top,rgba(91,255,191,0.08),transparent 65%),
        radial-gradient(circle at bottom,rgba(255,90,242,0.06),transparent 70%),
        #02000b;
      color:var(--accent);
      font-family:var(--font-ui);
      -webkit-font-smoothing:antialiased;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px;
    }
    .scan{
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:linear-gradient(to bottom,rgba(255,255,255,0.02) 1px,transparent 3px);
      opacity:0.04;
      mix-blend-mode:soft-light;
      z-index:-1;
    }
    .wrap{
      width:100%;
      max-width:1200px;
      background:
        radial-gradient(circle at top,rgba(255,90,242,0.06),transparent),
        radial-gradient(circle at bottom,rgba(45,228,255,0.05),transparent),
        rgba(3,0,18,0.98);
      border-radius:22px;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 26px 90px rgba(0,0,0,0.98);
      padding:16px;
      display:grid;
      grid-template-columns:minmax(0,1.8fr) minmax(260px,0.9fr);
      gap:16px;
    }
    @media(max-width:900px){
      .wrap{grid-template-columns:1fr;}
    }

    /* HEADER */
    .header{
      grid-column:1/-1;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:4px;
    }
    .h-left{display:flex;flex-direction:column;gap:4px;}
    .logo{
      font-size:11px;
      color:var(--accent3);
      letter-spacing:0.22em;
      text-transform:uppercase;
    }
    .title{
      font-size:24px;
      color:var(--accent2);
      text-shadow:0 0 18px rgba(91,255,191,0.7);
      font-family:var(--font-mono);
    }
    .subtitle{
      font-size:14px;
      color:var(--muted);
    }
    .tagline{
      font-size:11px;
      color:var(--accent3);
      text-transform:uppercase;
      letter-spacing:0.14em;
    }
    .h-right{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:flex-end;
      font-size:11px;
      color:var(--muted);
    }
    .pill{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(91,255,191,0.4);
      color:var(--accent);
      font-size:10px;
      margin-left:4px;
    }
    .leds span{
      display:inline-block;
      width:8px;height:8px;
      margin-left:3px;
      border-radius:50%;
      background:#111827;
      box-shadow:0 0 8px #000 inset;
    }
    .leds span.on1{background:var(--accent2);box-shadow:0 0 10px var(--accent2);}
    .leds span.on2{background:var(--accent3);box-shadow:0 0 10px var(--accent3);}
    .leds span.on3{background:var(--accent);box-shadow:0 0 10px var(--accent);}

    /* LEFT: GAME PANEL */
    .left{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .game-panel{
      background:var(--panel);
      border-radius:18px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 18px 60px rgba(0,0,0,0.96) inset;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:var(--muted);
    }
    .top-bar strong{color:var(--accent2);}
    .btn{
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(91,255,191,0.45);
      background:transparent;
      color:var(--accent);
      font-size:11px;
      cursor:pointer;
    }
    .btn:hover{
      background:rgba(91,255,191,0.14);
      box-shadow:0 6px 22px rgba(0,0,0,0.9);
    }

    .canvas-wrap{
      position:relative;
      border-radius:14px;
      overflow:hidden;
      background:
        radial-gradient(circle at top,rgba(45,228,255,0.12),transparent),
        radial-gradient(circle at center,rgba(255,90,242,0.06),transparent),
        #02000c;
      border:1px solid rgba(91,255,191,0.26);
      box-shadow:0 16px 40px rgba(0,0,0,0.95);
    }
    #gameCanvas{
      display:block;
      width:100%;
      height:320px;
    }

    .lanes-hint{
      position:absolute;
      left:0;right:0;bottom:6px;
      display:flex;
      justify-content:space-around;
      font-size:11px;
      color:var(--muted);
      text-shadow:0 0 6px #000;
      pointer-events:none;
    }

    .status{
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .status span strong{color:var(--accent2);}

    .hint{
      font-size:11px;
      color:var(--accent3);
      font-family:var(--font-mono);
    }

    /* RIGHT: SIDE PANEL */
    .right{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card{
      background:rgba(5,0,24,0.98);
      border-radius:16px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 16px 60px rgba(0,0,0,0.96);
      font-size:12px;
      color:var(--muted);
    }
    .card-title{
      font-size:13px;
      color:var(--accent2);
      text-transform:uppercase;
      letter-spacing:0.12em;
      margin-bottom:4px;
    }
    .stat-line{
      display:flex;
      justify-content:space-between;
      font-size:11px;
      margin-top:3px;
    }
    .stat-label{color:var(--muted);}
    .stat-value{color:var(--accent2);font-family:var(--font-mono);}

    .progress-bar{
      margin-top:5px;
      width:100%;
      height:8px;
      border-radius:999px;
      background:#02000c;
      border:1px solid rgba(91,255,191,0.24);
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--accent3),var(--accent2));
      transition:width 0.2s ease-out;
    }

    .story{
      margin-top:4px;
      font-size:11px;
      line-height:1.5;
    }
    .story strong{color:var(--accent);}

    .btn-small{
      margin-top:6px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(91,255,191,0.3);
      background:transparent;
      font-size:10px;
      color:var(--accent2);
      cursor:pointer;
    }
    .btn-small:hover{
      background:rgba(91,255,191,0.06);
      box-shadow:0 6px 22px rgba(0,0,0,0.9);
    }

    .safe{
      margin-top:4px;
      font-size:10px;
      color:var(--muted);
    }
  </style>
</head>
<body>
<div class="scan"></div>

<div class="wrap" id="kali-rush-root">
  <div class="header">
    <div class="h-left">
      <div class="logo">CRACKTHECODE // ARCADE MODULE</div>
      <div class="title">Kali Rush — Neon Lanes</div>
      <div class="subtitle">
        Glisse entre trois lignes néon pour capter les fragments de Kali.
        Simple, rapide, hypnotique, dans l’univers CrackTheCode.
      </div>
      <div class="tagline">REFLEXES · FLUX · LORE SAFE</div>
    </div>
    <div class="h-right">
      <div>Profil: <strong>sam@lane-runner</strong> <span class="pill">Casual Mode</span></div>
      <div>Best score: <span id="uiBestScore">0</span></div>
      <div>Best level: <span id="uiBestLevel">1</span></div>
      <div class="leds">
        <span class="on1"></span><span class="on2"></span><span class="on3"></span>
      </div>
    </div>
  </div>

  <!-- LEFT: GAME -->
  <div class="left">
    <div class="game-panel">
      <div class="top-bar">
        <div>Score: <strong id="uiScore">0</strong> · Niveau: <strong id="uiLevel">1</strong> · Combos: <strong id="uiCombo">x1</strong></div>
        <div>
          <button id="btnStart" class="btn">▶ Rejouer</button>
        </div>
      </div>
      <div class="canvas-wrap">
        <canvas id="gameCanvas"></canvas>
        <div class="lanes-hint">
          <div>⟵ A / ←</div>
          <div>S / ↓</div>
          <div>D / → ⟶</div>
        </div>
      </div>
      <div class="status">
        <span>Vies: <strong id="uiLives">3</strong></span>
        <span>Fragments Kali captés: <strong id="uiShards">0</strong></span>
        <span>Miss: <strong id="uiMiss">0</strong></span>
        <span id="uiState">Appuie sur ▶ ou une touche pour lancer.</span>
      </div>
      <div class="hint">
        Règle d’or: aligne Sam sous les fragments néon. Tu peux jouer au clavier ou cliquer/toucher dans la zone de chaque lane.
      </div>
    </div>
  </div>

  <!-- RIGHT: LORE / STATS / SAFE -->
  <div class="right">
    <div class="card">
      <div class="card-title">PROGRESSION NEON RUSH</div>
      <div class="progress-bar"><div id="progFill" class="progress-fill"></div></div>
      <div class="stat-line">
        <div class="stat-label">Runs terminés</div>
        <div class="stat-value" id="statRuns">0</div>
      </div>
      <div class="stat-line">
        <div class="stat-label">Plus longue combo</div>
        <div class="stat-value" id="statMaxCombo">x1</div>
      </div>
      <div class="stat-line">
        <div class="stat-label">Fragments totaux (local)</div>
        <div class="stat-value" id="statTotalShards">0</div>
      </div>
      <button id="btnSave" class="btn-small">Sauvegarder la progression locale</button>
      <button id="btnReset" class="btn-small">Reset progression locale</button>
    </div>

    <div class="card">
      <div class="card-title">FRAGMENTS NARRATIFS</div>
      <div class="story" id="loreBox">
        À chaque run, tu t'approches des souvenirs de <strong>Kali</strong>.
        Ce jeu est un espace de respiration entre deux missions plus techniques.
      </div>
      <button id="btnLore" class="btn-small">Afficher un fragment de Kali</button>
    </div>

    <div class="card">
      <div class="card-title">SÉCURITÉ & UNIVERS</div>
      <div class="safe">
        • Aucune commande, aucune IP, aucun trafic réel.<br>
        • Juste un jeu d’adresse visuel dans l’univers CrackTheCode.<br>
        • Parfait pour les visiteurs, les élèves, les parents, tout le monde.<br>
        • Tu peux le présenter comme porte d’entrée vers le reste de tes jeux.
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const uiScore = document.getElementById("uiScore");
  const uiLevel = document.getElementById("uiLevel");
  const uiCombo = document.getElementById("uiCombo");
  const uiLives = document.getElementById("uiLives");
  const uiShards = document.getElementById("uiShards");
  const uiMiss = document.getElementById("uiMiss");
  const uiState = document.getElementById("uiState");
  const uiBestScore = document.getElementById("uiBestScore");
  const uiBestLevel = document.getElementById("uiBestLevel");
  const statRuns = document.getElementById("statRuns");
  const statMaxCombo = document.getElementById("statMaxCombo");
  const statTotalShards = document.getElementById("statTotalShards");
  const progFill = document.getElementById("progFill");
  const loreBox = document.getElementById("loreBox");

  const btnStart = document.getElementById("btnStart");
  const btnSave = document.getElementById("btnSave");
  const btnReset = document.getElementById("btnReset");
  const btnLore = document.getElementById("btnLore");

  const SAVE_KEY = "ctc_kali_rush_progress_v1";

  const COLORS = {
    shardData: "#5bffbf",
    shardSync: "#2de4ff",
    shardGlitch: "#ff5af2",
    player: "#ffffff",
    laneGlow: "rgba(91,255,191,0.12)"
  };

  const loreFragments = [
    'KALI // "Chaque fragment que tu attrapes fixe un souvenir dans le neon-grid."',
    'KALI // "Tu joues, je respire. Continue."',
    'KALI // "L’Alliance pense en lignes droites. Toi, tu danses entre les flux."',
    'KALI // "Un jour, tous ces jeux formeront une seule passerelle vers la vérité."'
  ];

  let width = 0;
  let height = 0;
  let lanes = 3;
  let laneWidth = 0;
  let playerLane = 1; // 0,1,2
  let shards = [];
  let lastSpawn = 0;
  let spawnInterval = 650;
  let speedBase = 140;
  let running = false;
  let lastTime = 0;

  const state = {
    score:0,
    level:1,
    combo:1,
    comboCount:0,
    maxCombo:1,
    lives:3,
    shardsHit:0,
    shardsMiss:0,
    runs:0,
    totalShards:0,
    bestScore:0,
    bestLevel:1
  };

  function resize(){
    const rect = canvas.parentElement.getBoundingClientRect();
    width = rect.width;
    height = 320;
    canvas.width = width;
    canvas.height = height;
    laneWidth = width / lanes;
  }

  function resetRun(){
    state.score = 0;
    state.level = 1;
    state.combo = 1;
    state.comboCount = 0;
    state.lives = 3;
    state.shardsHit = 0;
    state.shardsMiss = 0;
    shards = [];
    spawnInterval = 650;
    speedBase = 140;
    lastSpawn = 0;
    updateUI();
    uiState.textContent = "Attrape les fragments néon. A/S/D ou ←/↓/→ pour bouger.";
  }

  function startRun(){
    resetRun();
    running = true;
    lastTime = performance.now();
    requestAnimationFrame(loop);
  }

  function endRun(){
    running = false;
    state.runs++;
    if(state.score > state.bestScore) state.bestScore = state.score;
    if(state.level > state.bestLevel) state.bestLevel = state.level;
    state.totalShards += state.shardsHit;
    if(state.combo > state.maxCombo) state.maxCombo = state.combo;
    saveAuto();
    updateUI();
    uiState.textContent = "Run terminée. Clique sur ▶ pour rejouer.";
  }

  function spawnShard(t){
    const lane = Math.floor(Math.random()*lanes);
    const types = ["data","sync","glitch"];
    const type = types[Math.floor(Math.random()*types.length)];
    shards.push({
      lane,
      y:-20,
      speed: speedBase + Math.random()*40,
      type,
      born:t
    });
  }

  function loop(t){
    if(!running) { draw(); return; }
    const dt = (t - lastTime)/1000;
    lastTime = t;

    // spawn
    lastSpawn += dt*1000;
    if(lastSpawn >= spawnInterval){
      lastSpawn = 0;
      spawnShard(t);
      // légère accélération
      if(state.level < 50){
        spawnInterval = Math.max(260, spawnInterval - 1.2);
        speedBase = Math.min(420, speedBase + 0.4);
      }
    }

    // update shards
    for(let i=shards.length-1;i>=0;i--){
      const s = shards[i];
      s.y += s.speed * dt;
      const laneX = s.lane * laneWidth;
      const playerX = playerLane * laneWidth + laneWidth/2;
      const playerY = height - 40;
      const distX = Math.abs((laneX+laneWidth/2) - playerX);
      const distY = Math.abs(s.y - playerY);

      // catch
      if(distY < 22 && distX < laneWidth*0.35){
        onCatch(s);
        shards.splice(i,1);
        continue;
      }

      // missed
      if(s.y > height + 20){
        onMiss();
        shards.splice(i,1);
      }
    }

    // game over?
    if(state.lives <= 0){
      endRun();
      draw();
      return;
    }

    draw();
    requestAnimationFrame(loop);
  }

  function onCatch(s){
    let gain = 10;
    if(s.type === "sync") gain = 14;
    if(s.type === "glitch") gain = 18;

    state.comboCount++;
    if(state.comboCount % 5 === 0){
      state.combo++;
      if(state.combo > state.maxCombo) state.maxCombo = state.combo;
    }

    state.shardsHit++;
    state.score += gain * state.combo;
    if(state.shardsHit % 8 === 0){
      state.level++;
    }
    updateUI();
  }

  function onMiss(){
    state.shardsMiss++;
    state.combo = 1;
    state.comboCount = 0;
    state.lives--;
    updateUI();
  }

  function updateUI(){
    uiScore.textContent = state.score;
    uiLevel.textContent = state.level;
    uiCombo.textContent = "x"+state.combo;
    uiLives.textContent = state.lives;
    uiShards.textContent = state.shardsHit;
    uiMiss.textContent = state.shardsMiss;
    uiBestScore.textContent = state.bestScore;
    uiBestLevel.textContent = state.bestLevel;
    statRuns.textContent = state.runs;
    statMaxCombo.textContent = "x"+state.maxCombo;
    statTotalShards.textContent = state.totalShards;
    const prog = Math.min(100, (state.bestScore/5000)*100);
    progFill.style.width = prog+"%";
  }

  function draw(){
    resize(); // keep responsive
    ctx.clearRect(0,0,width,height);

    // background lanes
    for(let i=0;i<lanes;i++){
      const x = i*laneWidth;
      ctx.fillStyle = "rgba(12,18,40,0.9)";
      ctx.fillRect(x+laneWidth*0.18, 0, laneWidth*0.64, height);
      ctx.fillStyle = "rgba(91,255,191,0.05)";
      ctx.fillRect(x+laneWidth*0.18, 0, laneWidth*0.64, height);
    }

    // center glow
    const grad = ctx.createRadialGradient(
      width/2, height*0.1, 10,
      width/2, height*0.6, height*0.9
    );
    grad.addColorStop(0,"rgba(255,90,242,0.06)");
    grad.addColorStop(1,"transparent");
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,width,height);

    // shards
    for(const s of shards){
      const laneCenter = s.lane*laneWidth + laneWidth/2;
      const r = 11;
      let col = COLORS.shardData;
      if(s.type==="sync") col = COLORS.shardSync;
      if(s.type==="glitch") col = COLORS.shardGlitch;
      ctx.save();
      ctx.translate(laneCenter, s.y);
      ctx.rotate((performance.now()/500 + s.born/200)% (Math.PI*2));
      ctx.strokeStyle = col;
      ctx.lineWidth = 2;
      ctx.shadowColor = col;
      ctx.shadowBlur = 14;
      ctx.beginPath();
      ctx.moveTo(0,-r);
      ctx.lineTo(r*0.8,0);
      ctx.lineTo(0,r);
      ctx.lineTo(-r*0.8,0);
      ctx.closePath();
      ctx.stroke();
      ctx.restore();
    }

    // player
    const px = playerLane*laneWidth + laneWidth/2;
    const py = height - 36;
    ctx.save();
    ctx.translate(px,py);
    ctx.fillStyle = "#ffffff";
    ctx.shadowColor = "#5bffbf";
    ctx.shadowBlur = 18;
    ctx.beginPath();
    ctx.arc(0,0,9,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = "rgba(91,255,191,0.9)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(0,0,13,0,Math.PI*2);
    ctx.stroke();
    ctx.restore();

    // subtle top text
    ctx.fillStyle = "rgba(160,174,192,0.25)";
    ctx.font = "10px "+getComputedStyle(document.body).fontFamily;
    ctx.fillText("KALI RUSH // CRACKTHECODE NEON GRID", 8, 14);
  }

  function moveLeft(){
    if(playerLane>0) playerLane--;
  }
  function moveRight(){
    if(playerLane<lanes-1) playerLane++;
  }
  function moveCenter(){
    playerLane = 1;
  }

  // Controls
  function handleKey(e){
    if(e.repeat) return;
    const k = e.key.toLowerCase();
    if(!running && (k===" " || k==="enter" || k==="a"||k==="s"||k==="d"||k==="arrowleft"||k==="arrowright"||k==="arrowdown")){
      startRun();
    }
    if(!running) return;
    if(k==="a" || k==="arrowleft") moveLeft();
    if(k==="d" || k==="arrowright") moveRight();
    if(k==="s" || k==="arrowdown") moveCenter();
  }

  function handleClick(e){
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    if(x < laneWidth) playerLane = 0;
    else if(x < laneWidth*2) playerLane = 1;
    else playerLane = 2;
    if(!running){
      startRun();
    }
  }

  // SAVE / LOAD
  function saveAuto(){
    try{
      const data = {
        bestScore:state.bestScore,
        bestLevel:state.bestLevel,
        runs:state.runs,
        totalShards:state.totalShards,
        maxCombo:state.maxCombo
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    }catch(e){}
  }

  function manualSave(){
    saveAuto();
    uiState.textContent = "Progression sauvegardée localement.";
  }

  function loadProgress(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return;
      const d = JSON.parse(raw);
      state.bestScore = d.bestScore||0;
      state.bestLevel = d.bestLevel||1;
      state.runs = d.runs||0;
      state.totalShards = d.totalShards||0;
      state.maxCombo = d.maxCombo||1;
      updateUI();
    }catch(e){}
  }

  function resetProgress(){
    if(!confirm("Réinitialiser la progression locale de Kali Rush ?")) return;
    localStorage.removeItem(SAVE_KEY);
    state.bestScore = 0;
    state.bestLevel = 1;
    state.runs = 0;
    state.totalShards = 0;
    state.maxCombo = 1;
    updateUI();
    uiState.textContent = "Progression réinitialisée. Prêt pour un nouveau rush.";
  }

  // LORE
  function showLore(){
    const frag = loreFragments[Math.floor(Math.random()*loreFragments.length)];
    loreBox.textContent = frag+"  // Univers fictif CrackTheCode.";
  }

  // Events
  btnStart.addEventListener("click", startRun);
  btnSave.addEventListener("click", manualSave);
  btnReset.addEventListener("click", resetProgress);
  btnLore.addEventListener("click", showLore);

  canvas.addEventListener("click", handleClick);
  window.addEventListener("keydown", handleKey);

  // INIT
  resize();
  loadProgress();
  resetRun();
  draw();

})();
</script>
</body>
</html>
